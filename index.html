<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitLin åœ¨çº¿æ™ºèƒ½åˆ‡å›¾å·¥å…·(æ‰“æ ‡å¸¸ç”¨)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --primary: #ffcc00; --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --error-bg: #441818; --error-text: #ff8888; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; min-height: 100vh; }
        .container { background: var(--panel); padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); width: 950px; max-width: 95%; margin-bottom: 40px; }
        
        h1 { color: #fff; margin: 0; text-align: center; font-size: 26px; font-weight: 600; }
        h1 span { color: var(--primary); font-size: 22px; }
        
        .desc-box { text-align: center; margin: 15px 0 25px 0; color: #aaa; font-size: 14px; background: #252525; padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary); }

        .tutorial-box { background: #2a2a2a; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; border: 1px solid #333; }
        .tutorial-box h3 { margin: 0 0 10px 0; color: #fff; font-size: 15px; }
        .tutorial-box ol { margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6; }
        .highlight-step { color: var(--primary); font-weight: bold; }

        .controls-wrapper { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .input-panel { flex: 2; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #2d2d2d; padding: 20px; border-radius: 8px; min-width: 300px; }
        .export-panel { flex: 1; background: #222; border: 1px solid #444; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; min-width: 220px; }
        
        label { font-size: 12px; color: #aaa; margin-bottom: 5px; display: block; font-weight: bold; }
        input[type="number"], select { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; font-weight: bold; font-size: 14px; box-sizing: border-box; }
        input[type="number"]:focus, select:focus { border-color: var(--primary); outline: none; }

        .res-display { font-size: 24px; font-weight: bold; color: #fff; text-align: center; margin: 10px 0; transition: color 0.3s; }
        .res-display.good { color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.3); }

        .main-btn { width: 100%; margin-top: 10px; padding: 16px; background: linear-gradient(135deg, #ffcc00 0%, #ffaa00 100%); color: #000; border: none; border-radius: 6px; font-weight: bold; font-size: 18px; cursor: pointer; }
        .main-btn:disabled { background: #444; color: #888; cursor: not-allowed; }
        
        /* æ–°å¢ï¼šçº¢è‰²è­¦å‘Šæ¡†æ ·å¼ */
        .win-warning { 
            margin-top: 15px; 
            padding: 15px; 
            background: var(--error-bg); 
            border: 1px solid #883333; 
            border-radius: 6px; 
            text-align: center; 
            color: var(--error-text);
            font-size: 14px;
            line-height: 1.6;
            animation: pulse 2s infinite;
        }
        .win-warning strong { color: #fff; font-size: 16px; display: block; margin-bottom: 5px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 100, 100, 0.2); } 70% { box-shadow: 0 0 0 6px rgba(255, 100, 100, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 100, 100, 0); } }

        .upload-area { margin-bottom: 20px; text-align: center; border: 2px dashed #444; padding: 25px; border-radius: 8px; cursor: pointer; transition: 0.2s; background: #252525; }
        .upload-area:hover { border-color: var(--primary); background: #2a2a2a; }
        
        #canvas-container { position: relative; width: 100%; overflow: hidden; border: 2px solid #444; border-radius: 4px; background: #000; margin-top: 20px; min-height: 200px; display: flex; align-items: center; justify-content: center; cursor: crosshair; }
        canvas { display: block; max-width: 100%; height: auto; touch-action: none; }

        .footer { margin-top: auto; padding-top: 20px; text-align: center; color: #666; font-size: 13px; border-top: 1px solid #333; width: 100%; }
        .author-tag { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>RabbitLin åœ¨çº¿æ™ºèƒ½åˆ‡å›¾å·¥å…·<span>(æ‰“æ ‡å¸¸ç”¨)</span></h1>
    
    <div class="desc-box">
        ä¸“ä¸º AI è®­ç»ƒè®¾è®¡ã€‚ä¸Šä¼  Grid æ‹¼å›¾ï¼Œä¸€é”®å¯¹é½ã€åˆ‡åˆ†å¹¶æ‰¹é‡å¯¼å‡ºç´ æã€‚
    </div>

    <div class="tutorial-box">
        <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
        <ol>
            <li><strong>ä¸Šä¼ </strong>ï¼šä¸Šä¼  MJ/SD ç”Ÿæˆçš„çŸ©é˜µå›¾ã€‚</li>
            <li><strong>å¯¹é½</strong>ï¼šæ‹–åŠ¨<span class="highlight-step">å·¦ä¸Šè§’çº¢æ¡†çš„å³ä¸‹è§’</span>è¿›è¡Œå¿«é€Ÿå¯¹é½ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥é—´è·ã€‚</li>
            <li><strong>å¯¼å‡º</strong>ï¼šå½“å°ºå¯¸æ˜¾ç¤ºä¸ºç»¿è‰² (å¦‚ 1024x1024) æ—¶ï¼Œç‚¹å‡»é»„è‰²æŒ‰é’®ä¸‹è½½ã€‚</li>
        </ol>
    </div>

    <div class="upload-area" onclick="document.getElementById('upload').click()">
        <input type="file" id="upload" accept="image/*" style="display: none;">
        <div style="font-size: 18px; margin-bottom: 5px;">ğŸ“‚ <strong>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</strong></div>
        <div id="file-info" style="font-size: 13px; color: #888;">æ”¯æŒ JPG / PNG / WEBP</div>
    </div>

    <div class="controls-wrapper">
        <div class="input-panel">
            <div><label>åˆ—æ•° (Cols)</label><input type="number" id="cols" value="5" min="1"></div>
            <div><label>è¡Œæ•° (Rows)</label><input type="number" id="rows" value="3" min="1"></div>
            <div><label>â†”ï¸ æ°´å¹³é—´è· (px)</label><input type="number" id="gap-x" value="96" min="0"></div>
            <div><label>â†•ï¸ å‚ç›´é—´è· (px)</label><input type="number" id="gap-y" value="96" min="0"></div>
        </div>

        <div class="export-panel">
            <label style="text-align:center;">å½“å‰åˆ‡ç‰‡å°ºå¯¸ (é¢„è§ˆ)</label>
            <div class="res-display" id="res-display">Waiting</div>
            
            <label style="margin-top:15px;">å¼ºåˆ¶ç¼©æ”¾è¾“å‡º (å¯é€‰)</label>
            <select id="resize-opt">
                <option value="original">ä¿æŒåŸå§‹å¤§å° (é»˜è®¤)</option>
                <option value="1024">å¼ºåˆ¶è½¬ä¸º 1024x1024</option>
                <option value="512">å¼ºåˆ¶è½¬ä¸º 512x512</option>
                <option value="768">å¼ºåˆ¶è½¬ä¸º 768x768</option>
            </select>
        </div>
    </div>

    <button id="processBtn" class="main-btn" disabled>âœ… ç¡®è®¤åˆ‡åˆ†å¹¶ä¸‹è½½ ZIP</button>

    <div class="win-warning">
        <strong>âš ï¸ Windows ç”¨æˆ·è¯·æ³¨æ„</strong>
        å¦‚æœç³»ç»Ÿæç¤ºâ€œæ–‡ä»¶å¯èƒ½æœ‰å®³â€æˆ–æŠ¥é”™ï¼Œè¿™æ˜¯ Windows çš„è¯¯æŠ¥ã€‚<br>
        <span style="color:#fff; font-weight:bold;">è¯·åŠ¡å¿…ä½¿ç”¨ 7-Zip æˆ– Bandizip ç­‰ç¬¬ä¸‰æ–¹è½¯ä»¶è¿›è¡Œè§£å‹ï¼</span><br>
        (ä¸è¦ä½¿ç”¨ Windows å³é”®èœå•è‡ªå¸¦çš„â€œå…¨éƒ¨è§£å‹ç¼©â€)
    </div>

    <div id="canvas-container">
        <canvas id="previewCanvas"></canvas>
    </div>
</div>

<div class="footer">
    Designed by <span class="author-tag">rabbitlin</span> | WeChat: <span class="author-tag">Aa272123071</span>
</div>

<script>
    const elements = {
        upload: document.getElementById('upload'),
        cols: document.getElementById('cols'),
        rows: document.getElementById('rows'),
        gapX: document.getElementById('gap-x'),
        gapY: document.getElementById('gap-y'),
        resizeOpt: document.getElementById('resize-opt'),
        processBtn: document.getElementById('processBtn'),
        canvas: document.getElementById('previewCanvas'),
        fileInfo: document.getElementById('file-info'),
        resDisplay: document.getElementById('res-display'),
        canvasContainer: document.getElementById('canvas-container')
    };
    const ctx = elements.canvas.getContext('2d');

    let state = {
        img: new Image(),
        isLoaded: false,
        cellW: 0, cellH: 0,
        isDragging: false,
        dragStartPos: { x: 0, y: 0 },
        initialCellSize: { w: 0, h: 0 },
        scaleFactor: 1
    };

    [elements.cols, elements.rows, elements.gapX, elements.gapY].forEach(input => {
        input.addEventListener('input', () => calculateAndDraw(false));
    });

    elements.upload.addEventListener('change', handleFileUpload);
    elements.processBtn.addEventListener('click', handleDownload);

    elements.canvas.addEventListener('mousedown', startDrag);
    elements.canvas.addEventListener('mousemove', handleDragMove);
    document.addEventListener('mouseup', stopDrag);
    elements.canvas.addEventListener('touchstart', (e) => startDrag(e.touches[0]));
    elements.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleDragMove(e.touches[0]); });
    document.addEventListener('touchend', stopDrag);

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            state.img.onload = () => {
                state.isLoaded = true;
                elements.processBtn.disabled = false;
                elements.fileInfo.innerHTML = `å·²åŠ è½½: <span style="color:#ffcc00">${state.img.width} x ${state.img.height}</span> px`;
                calculateAndDraw(false);
            }
            state.img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    function calculateAndDraw(fromDrag) {
        if (!state.isLoaded) return;

        const cols = parseInt(elements.cols.value) || 1;
        const rows = parseInt(elements.rows.value) || 1;
        let gapX = parseInt(elements.gapX.value) || 0;
        let gapY = parseInt(elements.gapY.value) || 0;

        if (!fromDrag) {
            state.cellW = Math.floor((state.img.width - (cols - 1) * gapX) / cols);
            state.cellH = Math.floor((state.img.height - (rows - 1) * gapY) / rows);
        } else {
            if (cols > 1) gapX = Math.floor((state.img.width - cols * state.cellW) / (cols - 1));
            if (rows > 1) gapY = Math.floor((state.img.height - rows * state.cellH) / (rows - 1));
            gapX = Math.max(0, gapX);
            gapY = Math.max(0, gapY);
            elements.gapX.value = gapX;
            elements.gapY.value = gapY;
        }

        updateUIDisplay();
        drawCanvas(cols, rows, gapX, gapY);
    }

    function updateUIDisplay() {
        elements.resDisplay.innerText = `${state.cellW} x ${state.cellH}`;
        const isGoodSize = (state.cellW === 1024 && state.cellH === 1024) || (state.cellW === 512 && state.cellH === 512);
        elements.resDisplay.classList.toggle('good', isGoodSize);
    }

    function drawCanvas(cols, rows, gapX, gapY) {
        elements.canvas.width = state.img.width;
        elements.canvas.height = state.img.height;
        state.scaleFactor = elements.canvas.clientWidth / state.img.width;

        ctx.drawImage(state.img, 0, 0);
        const lineWidth = Math.max(3, state.img.width / 300);
        ctx.lineWidth = lineWidth;

        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const posX = x * (state.cellW + gapX);
                const posY = y * (state.cellH + gapY);
                
                ctx.strokeStyle = '#ff0000';
                ctx.strokeRect(posX, posY, state.cellW, state.cellH);

                if (x === 0 && y === 0) {
                    ctx.fillStyle = '#ffcc00';
                    const handleSize = lineWidth * 4; 
                    ctx.fillRect(posX + state.cellW - handleSize, posY + state.cellH - handleSize, handleSize, handleSize);
                }
            }
        }
    }

    function getMousePosOnImage(clientObj) {
        const rect = elements.canvas.getBoundingClientRect();
        return {
            x: (clientObj.clientX - rect.left) / state.scaleFactor,
            y: (clientObj.clientY - rect.top) / state.scaleFactor
        };
    }

    function startDrag(e) {
        if (!state.isLoaded) return;
        const pos = getMousePosOnImage(e);
        const handleZone = Math.max(40, state.img.width / 30);
        if (Math.abs(pos.x - state.cellW) < handleZone && Math.abs(pos.y - state.cellH) < handleZone) {
            state.isDragging = true;
            state.dragStartPos = pos;
            state.initialCellSize = { w: state.cellW, h: state.cellH };
            elements.canvasContainer.style.cursor = 'nwse-resize';
        }
    }

    function handleDragMove(e) {
        if (!state.isDragging) return;
        const pos = getMousePosOnImage(e);
        const dx = pos.x - state.dragStartPos.x;
        const dy = pos.y - state.dragStartPos.y;

        const cols = parseInt(elements.cols.value) || 1;
        const rows = parseInt(elements.rows.value) || 1;
        
        let newW = state.initialCellSize.w + dx;
        let newH = state.initialCellSize.h + dy;
        newW = Math.max(50, Math.min(newW, state.img.width / cols));
        newH = Math.max(50, Math.min(newH, state.img.height / rows));
        
        state.cellW = Math.floor(newW);
        state.cellH = Math.floor(newH);
        calculateAndDraw(true);
    }

    function stopDrag() {
        if (state.isDragging) {
            state.isDragging = false;
            elements.canvasContainer.style.cursor = 'crosshair';
        }
    }

    async function handleDownload() {
        if (!state.isLoaded) return;
        const cols = parseInt(elements.cols.value);
        const rows = parseInt(elements.rows.value);
        let gapX = parseInt(elements.gapX.value);
        let gapY = parseInt(elements.gapY.value);
        const targetSize = elements.resizeOpt.value;

        const zip = new JSZip();
        const folder = zip.folder("images");
        
        const originalText = elements.processBtn.innerText;
        elements.processBtn.innerText = "â³ ç¼–ç ä¸­...";
        elements.processBtn.disabled = true;

        const finalCellW = state.cellW;
        const finalCellH = state.cellH;

        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = finalCellW;
                tempCanvas.height = finalCellH;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.drawImage(state.img, 
                    x * (finalCellW + gapX), y * (finalCellH + gapY), finalCellW, finalCellH, 
                    0, 0, finalCellW, finalCellH
                );

                let finalCanvas = tempCanvas;
                if (targetSize !== 'original') {
                    const size = parseInt(targetSize);
                    const resizeCanvas = document.createElement('canvas');
                    resizeCanvas.width = size;
                    resizeCanvas.height = size;
                    const resizeCtx = resizeCanvas.getContext('2d');
                    resizeCtx.imageSmoothingEnabled = true;
                    resizeCtx.imageSmoothingQuality = 'high';
                    resizeCtx.drawImage(tempCanvas, 0, 0, size, size);
                    finalCanvas = resizeCanvas;
                }

                const dataUrl = finalCanvas.toDataURL('image/png');
                const base64Data = dataUrl.replace(/^data:image\/(png|jpg);base64,/, "");
                folder.file(`image_${y}_${x}.png`, base64Data, {base64: true});
            }
        }

        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "dataset.zip");
            elements.processBtn.innerText = originalText;
            elements.processBtn.disabled = false;
        });
    }
</script>
</body>
</html>