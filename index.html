<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>RabbitLin Smart Slicer - AI Training Data Tool / åœ¨çº¿æ™ºèƒ½åˆ‡å›¾å·¥å…·(æ‰“æ ‡å¸¸ç”¨)</title>
    <meta name="description" content="RabbitLin V16.0: All-in-one AI image slicer supporting 16:9/9:16 resolutions. Features drag alignment, smart crop, and 9-point anchoring. æ”¯æŒé«˜æ¸…å®½å±/ç«–å±è¾“å‡ºã€9ç‚¹é”šç‚¹å®šä½ã€æ™ºèƒ½è£åˆ‡ã€‚">
    <meta name="keywords" content="RabbitLin, AI Slicer, LoRA Dataset, Image Splitter, AIåˆ‡å›¾, æ‰“æ ‡å·¥å…·, Midjourney Grid, 16:9 crop">
    <meta name="author" content="RabbitLin">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { --primary: #ffcc00; --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #2d2d2d; --wechat: #09bb07; --border: #444; }
        body { font-family: 'Segoe UI', Roboto, "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; min-height: 100vh; }
        .container { background: var(--panel); padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); width: 1100px; max-width: 98%; margin-bottom: 40px; position: relative; }
        
        /* Header */
        h1 { color: #fff; margin: 0; text-align: center; font-size: 26px; font-weight: 600; margin-bottom: 10px; }
        h1 span { color: var(--primary); font-size: 22px; }
        .subtitle { text-align: center; color: #888; font-size: 14px; margin-bottom: 20px; }

        /* Social Bar */
        .social-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .social-btn { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 50px; text-decoration: none; font-size: 13px; font-weight: bold; transition: transform 0.2s; cursor: pointer; border: none; }
        .social-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .btn-github { background: #333; color: #fff; border: 1px solid #555; }
        .btn-github span { color: var(--primary); }
        .btn-wechat { background: var(--wechat); color: #fff; }

        /* Tutorial Steps */
        .tutorial-steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 25px; background: #222; padding: 20px; border-radius: 8px; border: 1px solid #333; }
        .step-item { display: flex; align-items: flex-start; gap: 10px; }
        .step-num { background: var(--primary); color: #000; width: 24px; height: 24px; border-radius: 50%; text-align: center; font-size: 14px; font-weight: bold; line-height: 24px; flex-shrink: 0; }
        .step-text { font-size: 13px; color: #aaa; line-height: 1.5; }
        .step-text strong { color: #fff; display: block; margin-bottom: 4px; font-size: 14px; }
        .highlight { color: var(--primary); font-weight: bold; }

        /* Layout */
        .main-layout { display: flex; gap: 25px; flex-wrap: wrap; }
        .left-col { flex: 2; min-width: 300px; }
        .right-col { flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 15px; }

        /* Panel Structure */
        .panel { background: var(--accent); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
        .panel-title { font-size: 15px; font-weight: bold; color: #fff; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        
        .panel-section { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #444; }
        .panel-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .section-label { font-size: 12px; color: var(--primary); font-weight: bold; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Inputs */
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { font-size: 12px; color: #aaa; margin-bottom: 4px; display: block; font-weight: bold; }
        input[type="number"], select { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; font-weight: bold; font-size: 13px; box-sizing: border-box; }
        input[type="number"]:focus, select:focus { border-color: var(--primary); outline: none; }

        /* Sliders */
        .slider-group { margin-bottom: 15px; }
        input[type=range] { width: 100%; accent-color: var(--primary); margin-top: 5px; }
        .range-value { float: right; color: var(--primary); font-weight: bold; }

        /* Main Button */
        .main-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #ffcc00 0%, #ffaa00 100%); color: #000; border: none; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .main-btn:hover { filter: brightness(1.1); }
        .main-btn:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* Upload */
        .upload-area { text-align: center; border: 2px dashed #555; padding: 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; background: #222; margin-bottom: 20px; }
        .upload-area:hover { border-color: var(--primary); background: #2a2a2a; }

        /* Previews */
        #canvas-container { position: relative; width: 100%; overflow: hidden; border: 2px solid #444; border-radius: 4px; background: #000; min-height: 200px; display: flex; align-items: center; justify-content: center; cursor: crosshair; }
        canvas { display: block; max-width: 100%; height: auto; }
        .single-preview-box { background: #000; border: 1px solid #555; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 200px; position: relative; }
        .single-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .preview-label { position: absolute; top: 5px; left: 5px; font-size: 12px; color: rgba(255,255,255,0.7); background: rgba(0,0,0,0.6); padding: 2px 5px; border-radius: 3px; }

        .win-warning { margin-top: 15px; padding: 12px; background: #441818; border: 1px solid #883333; border-radius: 6px; text-align: center; color: #ff8888; font-size: 13px; display: none; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; text-align: center; max-width: 90%; width: 350px; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-box img { width: 100%; border-radius: 8px; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #333; cursor: pointer; font-weight: bold; }
        .modal-text { color: #333; margin-top: 10px; font-weight: bold; font-size: 16px; }
        .modal-sub { color: #666; font-size: 13px; margin-bottom: 10px; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .footer { margin-top: auto; padding-top: 20px; text-align: center; color: #666; font-size: 13px; border-top: 1px solid #333; width: 100%; }
        .author-tag { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>RabbitLin Smart Slicer <span>V16.0</span></h1>
    <div class="subtitle">åœ¨çº¿æ™ºèƒ½åˆ‡å›¾å·¥å…· (æ‰“æ ‡å¸¸ç”¨)</div>

    <div class="social-bar">
        <a href="https://github.com/rabbitlin-web/smart-crop-tool" target="_blank" class="social-btn btn-github">
            <svg height="16" width="16" viewBox="0 0 16 16" fill="#ffffff"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            Github æ±‚ Star (âœ§Ï‰âœ§)
        </a>
        <button class="social-btn btn-wechat" onclick="openModal()">
            ğŸ¥¤ æŠ•å–‚å…”å­ / Buy me a milk tea
        </button>
    </div>

    <div class="tutorial-steps">
        <div class="step-item">
            <div class="step-num">1</div>
            <div class="step-text"><strong>Upload / ä¸Šä¼ </strong>Click dashed box to upload grid image.<br>ç‚¹å‡»è™šçº¿æ¡†ä¸Šä¼ æ‹¼å›¾ã€‚</div>
        </div>
        <div class="step-item">
            <div class="step-num">2</div>
            <div class="step-text"><strong>Configure / é…ç½®ç»“æ„</strong>Set Cols & Rows first.<br>å…ˆè®¾ç½®è¡Œæ•°å’Œåˆ—æ•°ã€‚</div>
        </div>
        <div class="step-item">
            <div class="step-num">3</div>
            <div class="step-text"><strong>Align / å¯¹é½ (äºŒé€‰ä¸€)</strong>
                <span class="highlight">A. Drag (æ‹–æ‹½)</span> for visual fix.<br>
                <span class="highlight">B. Input (è¾“å…¥)</span> for precise gap.<br>
                æ‹–æ‹½é»„è‰²æ‰‹æŸ„ï¼Œæˆ–è€…è¾“å…¥é—´è·æ•°å€¼ã€‚
            </div>
        </div>
        <div class="step-item">
            <div class="step-num">4</div>
            <div class="step-text"><strong>Export / å¯¼å‡º</strong>Select Resolution & Mode.<br>é€‰æ‹©åˆ†è¾¨ç‡æ¨¡å¼ï¼Œç‚¹å‡»ä¸‹è½½ã€‚</div>
        </div>
    </div>

    <div class="upload-area" onclick="document.getElementById('upload').click()">
        <input type="file" id="upload" accept="image/*" style="display: none;">
        <div style="font-size: 18px; margin-bottom: 5px;">ğŸ“‚ <strong>Click to Upload / ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</strong></div>
        <div id="file-info" style="font-size: 13px; color: #888;">Support JPG / PNG / WEBP</div>
    </div>

    <div class="main-layout">
        <div class="left-col">
            <div class="panel">
                <div class="panel-title">1. Grid Structure / åŸºç¡€ç»“æ„è®¾ç½®</div>
                
                <div class="panel-section">
                    <span class="section-label">A. Step 1: Define Grid / å®šä¹‰è¡Œåˆ—</span>
                    <div class="control-grid">
                        <div><label>Columns / åˆ—æ•°</label><input type="number" id="cols" value="5" min="1"></div>
                        <div><label>Rows / è¡Œæ•°</label><input type="number" id="rows" value="3" min="1"></div>
                    </div>
                </div>

                <div class="panel-section">
                    <span class="section-label">B. Step 2: Alignment / å¯¹é½æ–¹å¼ (äºŒé€‰ä¸€)</span>
                    <div class="control-grid">
                        <div style="border-right: 1px dashed #444; padding-right: 10px;">
                            <label style="color:#fff;">Method 1: Visual Drag (æ¨è)</label>
                            <label style="font-weight:normal; font-size:11px;">Lock Ratio & Drag Yellow Handle</label>
                            <select id="aspect-ratio" style="margin-top:5px;">
                                <option value="free">Free / è‡ªç”±æ‹–æ‹½</option>
                                <option value="1">1:1 Square / æ­£æ–¹å½¢</option>
                                <option value="1.7777777">16:9 Landscape / æ¨ªå±</option>
                                <option value="0.5625">9:16 Portrait / ç«–å±</option>
                                <option value="1.3333333">4:3 Standard</option>
                            </select>
                        </div>
                        <div style="padding-left: 5px;">
                            <label style="color:#fff;">Method 2: Manual Input</label>
                            <label style="font-weight:normal; font-size:11px;">Input Precise Gap Values</label>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <input type="number" id="gap-x" value="96" min="0" placeholder="H-Gap">
                                <input type="number" id="gap-y" value="96" min="0" placeholder="V-Gap">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel" style="border-color: #554400; background: #26241a;">
                <div class="panel-title" style="color:#ffcc00;">2. Export Settings / å¯¼å‡ºè®¾ç½®</div>
                
                <div class="panel-section">
                    <span class="section-label">C. Step 3: Resolution & Mode / åˆ†è¾¨ç‡</span>
                    <div class="control-grid">
                        <div>
                            <label>Output Size / è¾“å‡ºåˆ†è¾¨ç‡ <span style="color:var(--primary);">(New!)</span></label>
                            <select id="resize-opt">
                                <option value="original">Original / åŸå§‹åˆ‡ç‰‡å¤§å°</option>
                                <option value="1024x1024">1024 x 1024 (Square)</option>
                                <option value="512x512">512 x 512 (Square)</option>
                                <option value="768x768">768 x 768 (Square)</option>
                                <option disabled>--- Landscape (16:9) ---</option>
                                <option value="1280x720">1280 x 720 (HD)</option>
                                <option value="1920x1080">1920 x 1080 (FHD)</option>
                                <option value="1024x576">1024 x 576 (Web)</option>
                                <option disabled>--- Portrait (9:16) ---</option>
                                <option value="720x1280">720 x 1280 (HD)</option>
                                <option value="576x1024">576 x 1024 (Web)</option>
                                <option value="1080x1920">1080 x 1920 (FHD)</option>
                            </select>
                        </div>
                        <div>
                            <label>Resize Mode / ç¼©æ”¾æ¨¡å¼</label>
                            <select id="resize-mode">
                                <option value="cover">Smart Crop (æ¨è! ä¸å˜å½¢)</option>
                                <option value="stretch">Stretch / å¼ºåˆ¶æ‹‰ä¼¸ (å˜å½¢)</option>
                                <option value="contain">Contain / ä¿ç•™é»‘è¾¹</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="slider-group" style="margin-top:10px; border-top:1px dashed #444; padding-top:10px;">
                    <label>Optional: Content Fine-tuning / å¾®è°ƒå†…å®¹</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="range" id="content-scale" min="50" max="150" value="100" step="1" style="flex:1;">
                        <span id="scale-val" style="font-size:12px; font-weight:bold; width:40px;">100%</span>
                    </div>
                    
                    <label style="margin-top:10px;">Anchor Position / é”šç‚¹ (9-Point) <span style="color:var(--primary);">(Updated!)</span></label>
                    <select id="anchor-pos">
                        <option value="center">Center / å±…ä¸­</option>
                        <option disabled>--- Top ---</option>
                        <option value="top-left">Top Left / å·¦ä¸Š</option>
                        <option value="top-center">Top Center / é¡¶éƒ¨å±…ä¸­</option>
                        <option value="top-right">Top Right / å³ä¸Š</option>
                        <option disabled>--- Middle ---</option>
                        <option value="middle-left">Middle Left / å±…å·¦</option>
                        <option value="middle-right">Middle Right / å±…å³</option>
                        <option disabled>--- Bottom ---</option>
                        <option value="bottom-left">Bottom Left / å·¦ä¸‹</option>
                        <option value="bottom-center">Bottom Center / åº•éƒ¨å±…ä¸­</option>
                        <option value="bottom-right">Bottom Right / å³ä¸‹</option>
                    </select>
                </div>
            </div>
            
            <button id="processBtn" class="main-btn" disabled>âœ… Confirm & Download / ç¡®è®¤ä¸‹è½½ ZIP</button>
            <div class="win-warning" id="win-alert">
                âš ï¸ <strong>Windows Users:</strong> Please use 7-Zip or Bandizip to extract.
            </div>
        </div>

        <div class="right-col">
            <div class="panel" style="padding:10px; margin:0;">
                <div class="panel-title" style="border:none; margin-bottom:5px;">Single Preview / å•å›¾é¢„è§ˆ</div>
                <div class="single-preview-box">
                    <span class="preview-label">Result Preview</span>
                    <img id="single-preview-img" alt="Waiting...">
                </div>
                <div style="text-align:center; margin-top:5px; font-size:12px; color:#888;">
                    Final Output: <span id="final-res" style="color:#ffcc00;">-- x --</span>
                </div>
            </div>

            <div class="panel" style="padding:10px; flex:1; display:flex; flex-direction:column;">
                <div class="panel-title" style="border:none; margin-bottom:5px;">Grid Alignment / æ•´ä½“å¯¹é½</div>
                <div style="font-size:11px; color:#666; margin-bottom:5px;">Drag yellow handle to adjust / æ‹–åŠ¨é»„è‰²æ‰‹æŸ„è°ƒèŠ‚</div>
                <div id="canvas-container" style="flex:1;">
                    <canvas id="previewCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    Designed by <span class="author-tag">RabbitLin</span> | å¾®ä¿¡å·: <span class="author-tag">Aa272123071</span>
</div>

<div id="qrModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-box">
        <div class="modal-close" onclick="closeModalBtn()">Ã—</div>
        <div class="modal-text">ğŸ¥¤ Buy me a Milk Tea ~</div>
        <div class="modal-sub">æ—¢ç„¶å¥½ç”¨ï¼Œå°±è¯·å…”å­å–æ¯èŒ¶å§ (å¼€å¿ƒ)</div>
        <img src="pay.jpg" alt="WeChat Pay" onerror="this.src='https://via.placeholder.com/300?text=Please+Upload+pay.jpg';">
        <div style="margin-top:10px; font-size:12px; color:#999;">WeChat Pay / å¾®ä¿¡æ”¯ä»˜</div>
    </div>
</div>

<script>
    function openModal() { document.getElementById('qrModal').style.display = 'flex'; }
    function closeModalBtn() { document.getElementById('qrModal').style.display = 'none'; }
    function closeModal(e) { if (e.target.id === 'qrModal') closeModalBtn(); }

    const el = {
        upload: document.getElementById('upload'),
        cols: document.getElementById('cols'), rows: document.getElementById('rows'),
        gapX: document.getElementById('gap-x'), gapY: document.getElementById('gap-y'),
        aspectRatio: document.getElementById('aspect-ratio'),
        contentScale: document.getElementById('content-scale'), scaleVal: document.getElementById('scale-val'),
        anchorPos: document.getElementById('anchor-pos'), 
        resizeOpt: document.getElementById('resize-opt'), resizeMode: document.getElementById('resize-mode'),
        processBtn: document.getElementById('processBtn'), canvas: document.getElementById('previewCanvas'),
        singlePreview: document.getElementById('single-preview-img'), finalRes: document.getElementById('final-res'),
        fileInfo: document.getElementById('file-info'), winAlert: document.getElementById('win-alert')
    };
    const ctx = el.canvas.getContext('2d');
    let state = { img: new Image(), isLoaded: false, cellW: 0, cellH: 0, isDragging: false, dragStartPos: {x:0,y:0}, initialCellSize: {w:0,h:0}, scaleFactor: 1 };

    const inputs = [el.cols, el.rows, el.gapX, el.gapY, el.aspectRatio, el.contentScale, el.anchorPos, el.resizeOpt, el.resizeMode];
    inputs.forEach(input => input.addEventListener('input', () => {
        if(input === el.contentScale) el.scaleVal.innerText = el.contentScale.value + '%';
        updateCalculation(false);
    }));

    el.upload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            state.img.onload = () => {
                state.isLoaded = true;
                el.processBtn.disabled = false;
                el.winAlert.style.display = 'block';
                el.fileInfo.innerHTML = `Loaded: <span style="color:#ffcc00">${state.img.width} x ${state.img.height}</span> px`;
                updateCalculation(false);
            }
            state.img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    });

    el.processBtn.addEventListener('click', async () => {
        if (!state.isLoaded) return;
        const cols = parseInt(el.cols.value), rows = parseInt(el.rows.value);
        let gapX = parseInt(el.gapX.value), gapY = parseInt(el.gapY.value);
        const zip = new JSZip();
        const folder = zip.folder("RabbitLin_Smart_Crops");
        const originalText = el.processBtn.innerText;
        el.processBtn.innerText = "â³ Processing...";
        el.processBtn.disabled = true;

        const rawW = state.cellW, rawH = state.cellH;
        
        // --- V16 New Resize Parsing Logic ---
        const resizeVal = el.resizeOpt.value;
        let targetW = rawW, targetH = rawH;

        if (resizeVal !== 'original') {
            if (resizeVal.includes('x')) {
                const parts = resizeVal.split('x');
                targetW = parseInt(parts[0]);
                targetH = parseInt(parts[1]);
            } else {
                // Fallback for old single values
                const s = parseInt(resizeVal);
                targetW = s; targetH = s;
            }
        }

        const scale = parseInt(el.contentScale.value) / 100;
        const anchor = el.anchorPos.value;
        const mode = el.resizeMode.value;

        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const pCanvas = document.createElement('canvas');
                pCanvas.width = targetW; pCanvas.height = targetH;
                const pCtx = pCanvas.getContext('2d');
                pCtx.fillStyle = '#000'; pCtx.fillRect(0, 0, targetW, targetH);
                pCtx.imageSmoothingEnabled = true; pCtx.imageSmoothingQuality = 'high';
                
                const srcX = x * (rawW + gapX);
                const srcY = y * (rawH + gapY);

                // Extraction canvas
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = rawW; tempCanvas.height = rawH;
                const tempCtx = tempCanvas.getContext('2d');

                let drawW = targetW, drawH = targetH;
                let drawX = 0, drawY = 0;

                if (mode === 'stretch') {
                    drawW = targetW * scale; drawH = targetH * scale;
                } else if (mode === 'cover' || mode === 'contain') {
                    const srcRatio = rawW / rawH;
                    const tgtRatio = targetW / targetH;
                    let renderScale = 1;
                    if (mode === 'cover') {
                        if (srcRatio > tgtRatio) renderScale = targetH / rawH;
                        else renderScale = targetW / rawW;
                    } else { // contain
                        if (srcRatio > tgtRatio) renderScale = targetW / rawW;
                        else renderScale = targetH / rawH;
                    }
                    renderScale *= scale;
                    drawW = rawW * renderScale;
                    drawH = rawH * renderScale;
                }

                // --- V16 New Anchor Logic (9-Point) ---
                // Horizontal
                if (anchor.includes('left')) drawX = 0;
                else if (anchor.includes('right')) drawX = targetW - drawW;
                else drawX = (targetW - drawW) / 2; // centers

                // Vertical
                if (anchor.includes('top')) drawY = 0;
                else if (anchor.includes('bottom')) drawY = targetH - drawH;
                else drawY = (targetH - drawH) / 2; // centers

                pCtx.drawImage(state.img, srcX, srcY, rawW, rawH, drawX, drawY, drawW, drawH);
                
                const dataUrl = pCanvas.toDataURL('image/png');
                folder.file(`crop_${y}_${x}.png`, dataUrl.replace(/^data:image\/(png|jpg);base64,/, ""), {base64: true});
            }
        }
        zip.generateAsync({type:"blob"}).then((content) => {
            saveAs(content, "smart_dataset.zip");
            el.processBtn.innerText = originalText;
            el.processBtn.disabled = false;
        });
    });

    function updateCalculation(fromDrag) {
        if (!state.isLoaded) return;
        const cols = parseInt(el.cols.value) || 1, rows = parseInt(el.rows.value) || 1;
        let gapX = parseInt(el.gapX.value) || 0, gapY = parseInt(el.gapY.value) || 0;
        if (!fromDrag) {
            state.cellW = Math.floor((state.img.width - (cols - 1) * gapX) / cols);
            state.cellH = Math.floor((state.img.height - (rows - 1) * gapY) / rows);
        } else {
            if (cols > 1) gapX = Math.floor((state.img.width - cols * state.cellW) / (cols - 1));
            if (rows > 1) gapY = Math.floor((state.img.height - rows * state.cellH) / (rows - 1));
            gapX = Math.max(0, gapX); gapY = Math.max(0, gapY);
            el.gapX.value = gapX; el.gapY.value = gapY;
        }
        drawGridPreview(cols, rows, gapX, gapY);
        updateSinglePreview(0, 0, gapX, gapY);
    }

    function drawGridPreview(cols, rows, gapX, gapY) {
        el.canvas.width = state.img.width; el.canvas.height = state.img.height;
        state.scaleFactor = el.canvas.clientWidth / state.img.width;
        ctx.drawImage(state.img, 0, 0);
        const lineWidth = Math.max(3, state.img.width / 300);
        ctx.lineWidth = lineWidth;
        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const posX = x * (state.cellW + gapX), posY = y * (state.cellH + gapY);
                ctx.strokeStyle = '#ff0000'; ctx.strokeRect(posX, posY, state.cellW, state.cellH);
                if (x === 0 && y === 0) { ctx.fillStyle = '#ffcc00'; const h = lineWidth * 4; ctx.fillRect(posX + state.cellW - h, posY + state.cellH - h, h, h); }
            }
        }
    }

    function updateSinglePreview(x, y, gapX, gapY) {
        const rawW = state.cellW, rawH = state.cellH;
        // Parsing V16
        const resizeVal = el.resizeOpt.value;
        let targetW = rawW, targetH = rawH;
        if (resizeVal !== 'original') {
            if (resizeVal.includes('x')) {
                const parts = resizeVal.split('x');
                targetW = parseInt(parts[0]);
                targetH = parseInt(parts[1]);
            } else {
                const s = parseInt(resizeVal);
                targetW = s; targetH = s;
            }
        }
        el.finalRes.innerText = `${targetW} x ${targetH}`;

        const pCanvas = document.createElement('canvas');
        pCanvas.width = targetW; pCanvas.height = targetH;
        const pCtx = pCanvas.getContext('2d');
        pCtx.fillStyle = '#000'; pCtx.fillRect(0, 0, targetW, targetH);
        pCtx.imageSmoothingEnabled = true; pCtx.imageSmoothingQuality = 'high';

        const scale = parseInt(el.contentScale.value) / 100;
        const anchor = el.anchorPos.value;
        const mode = el.resizeMode.value;

        let drawW = targetW, drawH = targetH;
        let drawX = 0, drawY = 0;

        if (mode === 'stretch') {
            drawW = targetW * scale; drawH = targetH * scale;
        } else if (mode === 'cover' || mode === 'contain') {
            const srcRatio = rawW / rawH;
            const tgtRatio = targetW / targetH;
            let renderScale = 1;
            if (mode === 'cover') {
                if (srcRatio > tgtRatio) renderScale = targetH / rawH;
                else renderScale = targetW / rawW;
            } else { 
                if (srcRatio > tgtRatio) renderScale = targetW / rawW;
                else renderScale = targetH / rawH;
            }
            renderScale *= scale;
            drawW = rawW * renderScale;
            drawH = rawH * renderScale;
        }

        if (anchor.includes('left')) drawX = 0;
        else if (anchor.includes('right')) drawX = targetW - drawW;
        else drawX = (targetW - drawW) / 2;

        if (anchor.includes('top')) drawY = 0;
        else if (anchor.includes('bottom')) drawY = targetH - drawH;
        else drawY = (targetH - drawH) / 2;

        pCtx.drawImage(state.img, x*(rawW+gapX), y*(rawH+gapY), rawW, rawH, drawX, drawY, drawW, drawH);
        el.singlePreview.src = pCanvas.toDataURL();
    }

    function getPos(e) { const r = el.canvas.getBoundingClientRect(); return { x: (e.clientX - r.left)/state.scaleFactor, y: (e.clientY - r.top)/state.scaleFactor }; }
    
    el.canvas.addEventListener('mousedown', (e) => {
        if (!state.isLoaded) return;
        const p = getPos(e), z = Math.max(40, state.img.width/30);
        if (Math.abs(p.x - state.cellW) < z && Math.abs(p.y - state.cellH) < z) { 
            state.isDragging = true; 
            state.dragStartPos = p; 
            state.initialCellSize = { w: state.cellW, h: state.cellH }; 
            el.canvas.style.cursor = 'nwse-resize'; 
        }
    });

    el.canvas.addEventListener('mousemove', (e) => {
        if (!state.isDragging) return;
        const p = getPos(e), cols = parseInt(el.cols.value)||1, rows = parseInt(el.rows.value)||1;
        
        let newW = state.initialCellSize.w + (p.x - state.dragStartPos.x);
        let newH = state.initialCellSize.h + (p.y - state.dragStartPos.y);
        
        const ratioVal = el.aspectRatio.value;
        if (ratioVal !== 'free') {
            const r = parseFloat(ratioVal);
            newH = Math.round(newW / r);
        }

        newW = Math.floor(Math.max(50, Math.min(newW, state.img.width/cols)));
        newH = Math.floor(Math.max(50, Math.min(newH, state.img.height/rows)));
        
        state.cellW = newW;
        state.cellH = newH;
        updateCalculation(true);
    });

    document.addEventListener('mouseup', () => { state.isDragging = false; el.canvas.style.cursor = 'crosshair'; });
</script>
</body>
</html>
